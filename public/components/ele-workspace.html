<link rel="import" href="../bower_components/ace-element/ace-element.html">
<link rel="import" href="../bower_components/polymer-flex-layout/polymer-flex-layout.html">
<link rel="import" href="../bower_components/polymer-ui-splitter/polymer-ui-splitter.html">

<link rel="import" href="ele-preview.html">
<link rel="import" href="ele-ajax.html">

<script src="../bower_components/lodash/dist/lodash.js"></script>

<polymer-element name="ele-workspace">
  <template>
    <link rel="stylesheet" href="ele-workspace.css">
    
    <pvc-globals id="globals" values="{{globals}}"></pvc-globals>
    
    <polymer-flex-layout></polymer-flex-layout>
    <panel id="sourceContainer">
      <div class="card"><ace-element id="elementEditor" theme="clouds" mode="html" tabSize="2" on-editor-input="{{editorChanged}}">{{globals.package.files[globals.package.name + '.html']}}</ace-element></div>
    </panel>
    <polymer-ui-splitter direction="left"></polymer-ui-splitter>
    <section flex>
      <polymer-flex-layout vertical></polymer-flex-layout>
      <panel id="previewContainer">
        <ele-preview class="card" 
          demo="{{$.demoEditor}}" 
          element="{{$.elementEditor}}">
        </ele-preview>
      </panel>
      <polymer-ui-splitter direction="up"></polymer-ui-splitter>
      <panel flex id="demoContainer">
        <div class="card"><ace-element id="demoEditor" theme="clouds" mode="html" on-editor-input="{{editorChanged}}" tabSize="2">{{globals.package.files['demo.html']}}</ace-element></div>
      </panel>
    </section>
  </template>
  
  <script>
    (function() {
      var NAME_REGEX = /<polymer-element.* name=['"]([a-z0-9-]+)['"]/i
    
      Polymer('ele-workspace', {
        ready: function() {
          this._updateName = _.debounce(this.updateName.bind(this), 1000);
          this._save = _.debounce(this.save.bind(this), 5000);
        },
        editorChanged: function() {
          console.log("Editor changed...");
          this._updateName();
          this._save();
        },
        updateName: function() {
          var source = this.$.elementEditor.editorValue;
          var match = source.match(NAME_REGEX);
          if (match && match[1]) {
            this.globals.package.name = match[1].trim();
          }
        },
        save: function() {
          this.fire('core-signal', {name: 'save', data: {source: this.$.elementEditor.editorValue, demo: this.$.demoEditor.editorValue}});
        },
        saveSucceeded: function() {
          this.parentNode.saveSucceeded();
        }
      });
    })();
  </script>
</polymer-element>