<polymer-element name="ele-preview" attributes="element demo">
  <template>
    <style>
      :host {
        position: relative;
      }

      iframe {
        border: none;
        width: 100%;
        height: 100%;
        position: absolute;
      }
    </style>
    <iframe></iframe>
  </template>
  <script>
    function debounce(func, wait, immediate) {
      var timeout;
      return function() {
        var context = this, args = arguments;
        clearTimeout(timeout);
        if (immediate && !timeout) func.apply(context, args);
        timeout = setTimeout(function() {
          timeout = null;
          if (!immediate) func.apply(context, args);
        }, wait);
      };
    };

    Polymer('ele-preview', {
      animationFrameRequest: undefined,
      attached: function() {
        var changeHandler = debounce(this.sourceChanged.bind(this), 100);
        this.element.addEventListener('editor-input', changeHandler);
        this.demo.addEventListener('editor-input', changeHandler);
        this.sourceChanged();
      },
      sourceChanged: function() {
        console.log('sourceChanged');
        if(this.animationFrameRequest) {
          cancelAnimationFrame(this.animationFrameRequest);
          this.animationFrameRequest = undefined;
        }
        this.animationFrameRequest = requestAnimationFrame(function() {
          this.animationFrameRequest = undefined;
          this.buildFrame(function(frame) {
            this.shadowRoot.removeChild(this.shadowRoot.children[1]);
          });
        }.bind(this));
      },
      buildFrame: function(callback) {
        var frame = document.createElement('iframe');
        this.shadowRoot.appendChild(frame);
        var _document = frame.contentDocument;
        _document.open('text/html', '');
        _document.write('<script src="/bower_components/platform/platform.js"></s'+'cript>');
        _document.write('<link rel="import" href="/bower_components/polymer/polymer.html">');
        _document.write(this.element.editorValue);
        _document.write(this.demo.editorValue);
        _document.close();
        frame.contentWindow.addEventListener('polymer-ready', function() {
          callback.call(this, frame);
        }.bind(this));
      }
    });
  </script>
</polymer-element>